{% extends 'base.html' %}
{% load static %}

{% block content %}
<head>
    <link rel='stylesheet' href='{% static 'css/sales.css' %}'>
</head>

<div class='sales-container'>
    <div class='checkout-interface'>
        <div class='search-bar'>
            <label for='barcode'>Search by Barcode:</label>
            <input type='text' id='barcode' placeholder='Enter barcode'>
            <button id='search-btn'>Search</button>
        </div>

        <div class='departments'>
            <h3>Grocery</h3>
            <button class='department-btn' department-id='bakery'>Bakery</button>
            <button class='department-btn' department-id='fruits-vegetables'>Fruits &amp; Vegetables</button>
            <button class='department-btn' department-id='dairy'>Dairy</button>
            <button class='department-btn' department-id='meat-poultry'>Meat &amp; Poultry</button>
        </div>

        <div class='checkout-list'>
            <h3>Checkout</h3>
            <table id='checkout-list-table'>
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id='checkout-items'>
                    <!-- Items will be added here dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <div class='payment_interface'>
        <div class='transaction-info'>
            <h3>Transaction Info</h3>
            <div class='transaction-info-item'>
                <label for='subtotal'>Subtotal:</label>
                <span id='subtotal'>$0.00</span>
            </div>
            <div class='transaction-info-item'>
                <label for='tax'>Tax (7%):</label>
                <span id='tax'>$0.00</span>
            </div>
            <div class='transaction-info-item'>
                <label for='discount'>Discount Total:</label>
                <span id='discount'>$0.00</span>
            </div>
            <div class='transaction-info-item'>
                <label id='grand-total-label' for='grand-total'>Grand Total:</label>
                <span id='grand-total'>$0.00</span>
            </div>
        </div>

        <div class='payment-options'>
            <div class='payment-btn-container'>
                <button id='pay-btn' class='pay-btn'>Pay</button>
                <!-- Per Item Discounts -->
                <button class='discount-btn' id='discount-single-item'>Item Discount</button>
                <!-- Per Order Discounts -->
                <button class='discount-btn' id='discount-rewards-member'>Rewards Member Discount (10%)</button>
                <!-- Other Discounts -->
                <button class='discount-btn' id='discount-employee'>Employee Discount (15%)</button>
                <button class='discount-btn' id='discount-manager'>Manager Comp</button>
            </div>
        </div>

        <div class='receipt'>
            <h3>Receipt</h3>
            <!-- Add receipt generation -->
        </div>
    </div>
</div>

<script>
document.getElementById('search-btn').addEventListener('click', searchItem);
document.getElementById('barcode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchItem();
    }
});

function searchItem() {
    const barcode = document.getElementById('barcode').value;
    
    fetch(`/api/item/search/?barcode=${barcode}`)
        .then(response => response.json())
        .then(item => {
            if (item) {
                addItemToCheckout(item);
                document.getElementById('barcode').value = ''; // Clear input
            } else {
                alert('Item not found');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error searching for item');
        });
}

function addItemToCheckout(item) {
    const tbody = document.getElementById('checkout-items');
    
    // Check if item already exists in checkout
    const existingRow = tbody.querySelector(`tr[data-item-id="${item.id}"]`);
    if (existingRow) {
        // Increment quantity if item exists
        const quantityInput = existingRow.querySelector('.quantity-input');
        quantityInput.value = parseInt(quantityInput.value) + 1;
        updateRowTotal(existingRow);
    } else {
        // Add new row if item doesn't exist
        const row = document.createElement('tr');
        row.setAttribute('data-item-id', item.id);
        
        row.innerHTML = `
            <td>${item.name}</td>
            <td>$${item.cost}</td>
            <td>
                <input type="number" class="quantity-input" value="1" min="1" 
                       onchange="updateRowTotal(this.parentElement.parentElement)">
            </td>
            <td>$${item.cost}</td>
            <td>
                <button onclick="removeItem(this.parentElement.parentElement)">Remove</button>
            </td>
        `;
        
        tbody.appendChild(row);
    }
    
    updateTotals();
}

function updateRowTotal(row) {
    const price = parseFloat(row.cells[1].textContent.replace('$', ''));
    const quantity = parseInt(row.querySelector('.quantity-input').value);
    const total = price * quantity;
    row.cells[3].textContent = `$${total.toFixed(2)}`;
    updateTotals();
}

function removeItem(row) {
    row.remove();
    updateTotals();
}

function updateTotals() {
    let subtotal = 0;
    document.querySelectorAll('#checkout-items tr').forEach(row => {
        subtotal += parseFloat(row.cells[3].textContent.replace('$', ''));
    });
    
    const tax = subtotal * 0.07;
    const total = subtotal + tax;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
    document.getElementById('grand-total').textContent = `$${total.toFixed(2)}`;
}
</script>

{% endblock %}